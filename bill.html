<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krystal Billing System</title>
    <link rel="icon" type="image/png" href="logo.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <a href="index.html" class="btn-tool btn-ledger" target="_blank">ðŸ§¾ Go to Stock</a>
    <a href="ledger.html" class="btn-tool btn-ledger" target="_blank">ðŸ“’ Go to Ledger</a>


    <style>
        :root { --primary: #b91c1c; --bg: #f3f4f6; --text: #1f2937; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        
        .container { max-width: 900px; margin: 0 auto; }
        
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .header img { height: 50px; }
        .header h1 { color: var(--primary); margin: 0; font-size: 1.8rem; }

        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .section-title { font-weight: bold; color: #555; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 15px; margin-top: 0; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }

        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #4b5563; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        
        .items-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .items-table th { text-align: left; background: #f9fafb; padding: 10px; font-size: 0.85rem; color: #6b7280; }
        .items-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .items-table input { border: 1px solid #e5e7eb; padding: 8px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.95rem; }
        .btn-add { background: #e0e7ff; color: #3730a3; width: 100%; margin-bottom: 20px; }
        .btn-generate { background: var(--primary); color: white; width: 100%; font-size: 1.1rem; padding: 15px; }
        .btn-remove { background: #fee2e2; color: #991b1b; padding: 5px 10px; font-size: 0.8rem; }
        .btn-download { background: #059669; color: white; padding: 6px 12px; font-size: 0.85rem; border-radius: 4px; }
        
        .total-section { display: flex; justify-content: flex-end; margin-bottom: 20px; }
        .total-box { background: #f9fafb; padding: 15px; border-radius: 8px; width: 300px; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; }
        .final-total { font-weight: bold; font-size: 1.3rem; color: var(--primary); border-top: 2px solid #e5e7eb; padding-top: 10px; margin-top: 5px; }
        
        .history-table { width: 100%; border-collapse: collapse; }
        .history-table th, .history-table td { text-align: left; padding: 12px; border-bottom: 1px solid #e5e7eb; }
        .history-table th { background: #f3f4f6; }

        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .checkbox-wrapper input { width: auto; }

        .btn-tool {
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-right: 10px;
            display: inline-block;
            color: white;
            transition: background 0.2s;
        }
        .btn-ledger {
            background: #930303; /* Green for Ledger */
        }
        .btn-ledger:hover { background: #047857; }

        @media (max-width: 600px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .items-table th, .items-table td { display: block; width: 100%; box-sizing: border-box; }
            .items-table tr { border-bottom: 2px solid #ddd; display: block; margin-bottom: 10px; }
            .total-box { width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="logo.png" id="invoiceLogo" alt="Logo">
        <h1>Billing System</h1>
    </div>

    <div class="card">
        <h3 class="section-title">Invoice Info</h3>
        <div class="grid-3">
            <div>
                <label>Invoice Number</label>
                <input type="text" id="invNumber" placeholder="1175">
            </div>
            <div>
                <label>Date</label>
                <input type="date" id="invDate">
            </div>
            <div>
                <label>Kind Attn</label>
                <input type="text" id="kindAttn" placeholder="e.g. Rakesh">
            </div>
        </div>
        <div class="grid-3">
            <div>
                <label>P.O. No.</label>
                <input type="text" id="poNumber" placeholder="e.g. by mail">
            </div>
            <div>
                <label>Job Sheet No.</label>
                <input type="text" id="jobSheetNo">
            </div>
            <div>
                <label>From (Sender)</label>
                <input type="text" id="senderName" value="Aliasger Fatakdawala">
            </div>
        </div>

        <h3 class="section-title">Client Details</h3>
        <div class="grid-2">
            <div>
                <label>Client Name (Auto-Fill)</label>
                <input type="text" id="clientName" list="savedClients" onchange="autoFillClient()" placeholder="Start typing name...">
                <datalist id="savedClients">
                    </datalist>
            </div>
            <div>
                <label>Client GSTIN</label>
                <input type="text" id="clientGst" placeholder="e.g. 24AWNPS5939B1Z9">
            </div>
            <div style="grid-column: span 2;">
                <label>Client Address</label>
                <textarea id="clientAddress" rows="2" placeholder="Full Address..."></textarea>
            </div>
        </div>

        <h3 class="section-title">Items</h3>
        <table class="items-table">
            <thead>
                <tr>
                    <th style="width: 5%;">Sr.</th>
                    <th style="width: 35%;">Description</th>
                    <th style="width: 15%;">HSN</th>
                    <th style="width: 15%;">Qty</th>
                    <th style="width: 15%;">Rate (â‚¹)</th>
                    <th style="width: 15%;">Amount</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="itemsBody"></tbody>
        </table>
        
        <button class="btn btn-add" onclick="addItemRow()">+ Add Item</button>

        <div class="total-section">
            <div class="total-box">
                <div class="total-row">
                    <span>Subtotal:</span>
                    <span>â‚¹ <span id="subTotal">0.00</span></span>
                </div>
                
                <div style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">
                    <div class="total-row" style="align-items: center;">
                        <span>Tax Rate:</span>
                        <select id="taxRate" style="width: 80px; padding: 4px;" onchange="calcTotals()">
                            <option value="0">0%</option>
                            <option value="5">5%</option>
                            <option value="12">12%</option>
                            <option value="18" selected>18%</option>
                            <option value="28">28%</option>
                        </select>
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="isIGST" onchange="calcTotals()">
                        <label for="isIGST" style="font-weight: normal; margin:0;">Inter-state (IGST)</label>
                    </div>
                </div>

                <div class="total-row">
                    <span>Total Tax:</span>
                    <span style="color: #dc2626;">+ â‚¹ <span id="taxAmount">0.00</span></span>
                </div>
                <div class="total-row final-total">
                    <span>Grand Total:</span>
                    <span>â‚¹ <span id="grandTotal">0.00</span></span>
                </div>
            </div>
        </div>

        <button class="btn btn-generate" id="saveBtn">Save & Download Invoice</button>
    </div>

    <div class="card">
        <h3 class="section-title">Invoice History</h3>
        <input type="text" id="searchHistory" placeholder="Search Client..." style="width:100%; margin-bottom:15px; padding:10px; border:1px solid #ddd; border-radius:6px;">
        <table class="history-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Invoice #</th>
                    <th>Client</th>
                    <th>Total</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, setDoc, doc, onSnapshot, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDAk5j4xu-ijD_qU2cBFVlz5_E1GTyhSEc",
        authDomain: "krystal-stock-3ef74.firebaseapp.com",
        projectId: "krystal-stock-3ef74",
        storageBucket: "krystal-stock-3ef74.firebasestorage.app",
        messagingSenderId: "413901545424",
        appId: "1:413901545424:web:6450cece775245a52a23d5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const invCol = collection(db, "invoices");
    const clientCol = collection(db, "clients"); // NEW CLIENT DB

    document.getElementById('invDate').valueAsDate = new Date();

    // --- 1. CLIENT AUTO-FILL LOGIC ---
    let clientMap = {}; // Local storage for loaded clients

    // Load all clients on startup
    onSnapshot(collection(db, "clients"), (snapshot) => {
        const datalist = document.getElementById('savedClients');
        datalist.innerHTML = ""; // Clear existing
        clientMap = {}; 

        snapshot.forEach(doc => {
            const c = doc.data();
            clientMap[c.name] = c; // Map name to details
            const option = document.createElement('option');
            option.value = c.name;
            datalist.appendChild(option);
        });
    });

    // Function to fill details when name is selected
    window.autoFillClient = function() {
        const name = document.getElementById('clientName').value;
        if(clientMap[name]) {
            document.getElementById('clientGst').value = clientMap[name].gst || "";
            document.getElementById('clientAddress').value = clientMap[name].address || "";
        }
    }

    // --- 2. UI LOGIC ---
    let rowCount = 0;
    window.addItemRow = function() {
        rowCount++;
        const tbody = document.getElementById('itemsBody');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" value="${rowCount}" class="sr" style="text-align:center;"></td>
            <td><input type="text" placeholder="Item Name" class="desc"></td>
            <td><input type="text" value="7018" class="hsn"></td>
            <td><input type="number" value="1" class="qty" oninput="window.calcRow(this)"></td>
            <td><input type="number" value="0" class="rate" oninput="window.calcRow(this)"></td>
            <td><input type="text" value="0.00" class="amount" readonly></td>
            <td><button class="btn btn-remove" onclick="window.removeRow(this)">Ã—</button></td>
        `;
        tbody.appendChild(row);
    }

    window.removeRow = function(btn) {
        btn.closest('tr').remove();
        window.calcTotals();
    }

    window.calcRow = function(input) {
        const row = input.closest('tr');
        const qty = parseFloat(row.querySelector('.qty').value) || 0;
        const rate = parseFloat(row.querySelector('.rate').value) || 0;
        row.querySelector('.amount').value = (qty * rate).toFixed(2);
        window.calcTotals();
    }

    window.calcTotals = function() {
        let sub = 0;
        document.querySelectorAll('.amount').forEach(i => sub += parseFloat(i.value) || 0);
        
        const rate = parseFloat(document.getElementById('taxRate').value) || 0;
        const tax = sub * (rate / 100);
        
        document.getElementById('subTotal').innerText = sub.toFixed(2);
        document.getElementById('taxAmount').innerText = tax.toFixed(2);
        document.getElementById('grandTotal').innerText = (sub + tax).toFixed(2);
    }

    window.addItemRow(); 

    // --- 3. SAVE & GENERATE ---
    document.getElementById('saveBtn').addEventListener('click', async () => {
        const clientName = document.getElementById('clientName').value;
        const clientGst = document.getElementById('clientGst').value;
        const clientAddress = document.getElementById('clientAddress').value;

        if(!clientName) { alert("Please enter Client Name"); return; }

        // Gather Invoice Data
        const items = [];
        document.querySelectorAll('#itemsBody tr').forEach(row => {
            items.push({
                sr: row.querySelector('.sr').value,
                desc: row.querySelector('.desc').value,
                hsn: row.querySelector('.hsn').value,
                qty: row.querySelector('.qty').value,
                rate: row.querySelector('.rate').value,
                amount: row.querySelector('.amount').value
            });
        });

        const invoiceData = {
            invNo: document.getElementById('invNumber').value,
            date: document.getElementById('invDate').value,
            kindAttn: document.getElementById('kindAttn').value,
            poNo: document.getElementById('poNumber').value,
            jobSheet: document.getElementById('jobSheetNo').value,
            sender: document.getElementById('senderName').value,
            client: clientName,
            clientGst: clientGst,
            clientAddr: clientAddress,
            subTotal: document.getElementById('subTotal').innerText,
            taxRate: document.getElementById('taxRate').value,
            isIGST: document.getElementById('isIGST').checked,
            taxAmount: document.getElementById('taxAmount').innerText,
            grandTotal: document.getElementById('grandTotal').innerText,
            items: items,
            timestamp: Timestamp.now()
        };

        try {
            // 1. Save Invoice
            await addDoc(invCol, invoiceData);

            // 2. Save/Update Client for Future
            await setDoc(doc(db, "clients", clientName), {
                name: clientName,
                gst: clientGst,
                address: clientAddress
            });
            
            // 3. Generate PDF
            window.generatePDF(invoiceData);
            
            alert("Invoice Saved & Downloaded!");
        } catch (error) {
            console.error(error);
            alert("Error saving invoice");
        }
    });

    // --- 4. EXACT FORMAT PDF GENERATOR ---
    window.generatePDF = function(data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const img = document.getElementById('invoiceLogo');

        // Logo & Header
        if(img.naturalWidth > 0) {
            const canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
        }

        doc.setFont("helvetica", "bold");
        doc.setFontSize(26);
        doc.setTextColor(185, 28, 28);
        doc.text("KRYSTAL", 105, 15, { align: 'center' }); 

        doc.setFontSize(10);
        doc.setTextColor(0,0,0);
        doc.text("TROPHIES, MEMENTOES & GIFTS", 105, 21, { align: 'center' });

        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.text("44/B, Mumbai Timber Market, Signal Hill Avenue, ReayRoad (E), Mumbai: 400010", 105, 27, { align: 'center' });

        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text("TAX INVOICE", 105, 36, { align: 'center' });
        doc.line(10, 38, 200, 38); 

        // LEFT SIDE: CLIENT
        let y = 45;
        doc.setFontSize(10);
        doc.text("TO", 14, y); y += 5;
        doc.setFontSize(11);
        doc.text(data.client, 14, y); y += 5;
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        const addrLines = doc.splitTextToSize(data.clientAddr, 90);
        doc.text(addrLines, 14, y);
        y += (addrLines.length * 5) + 2;
        
        doc.setFont("helvetica", "bold");
        doc.text(`Party's GSTIN: ${data.clientGst}`, 14, y);

        // RIGHT SIDE: META
        const rightX = 120;
        let rightY = 45;
        
        doc.setFontSize(10);
        doc.text(`INVOICE NO:  ${data.invNo}`, rightX, rightY); rightY += 5;
        doc.text(`Date:  ${formatDate(data.date)}`, rightX, rightY); rightY += 7;
        
        doc.text(`Kind Attn:  ${data.kindAttn}`, rightX, rightY); rightY += 5;
        doc.text(`P.O No.:  ${data.poNo}`, rightX, rightY); rightY += 5;
        doc.text(`From:  ${data.sender}`, rightX, rightY); rightY += 5;
        doc.text(`Job Sheet No.:  ${data.jobSheet}`, rightX, rightY);

        // TABLE
        const tableBody = data.items.map(i => [i.sr, i.desc, i.qty, "pcs", i.rate, i.amount]); 

        doc.autoTable({
            startY: 85,
            head: [['Sr. No.', 'Description', 'Qty', 'Unit', 'Rate', 'Amount']],
            body: tableBody,
            theme: 'plain',
            styles: { fontSize: 9, cellPadding: 2, lineColor: 10, lineWidth: 0.1 },
            headStyles: { fillColor: [240, 240, 240], textColor: 0, fontStyle: 'bold', halign: 'center' },
            columnStyles: {
                0: { halign: 'center', cellWidth: 15 },
                1: { cellWidth: 80 },
                2: { halign: 'center' },
                3: { halign: 'center' },
                4: { halign: 'right' },
                5: { halign: 'right' }
            }
        });

        let finalY = doc.lastAutoTable.finalY + 5;

        // FOOTER BANK DETAILS
        const bankY = finalY + 5;
        doc.setFontSize(9);
        doc.setFont("helvetica", "bold");
        doc.text("BANK DETAILS", 14, bankY);
        doc.setFont("helvetica", "normal");
        doc.text("ICICI BANK", 14, bankY + 4);
        doc.text("BRANCH: MAZGOAN", 14, bankY + 8);
        doc.text("ACCOUNT NAME: KRYSTAL", 14, bankY + 12);
        doc.text("ACCOUNT NO: 107105000799", 14, bankY + 16);
        doc.text("RTGS/NEFT IFSC: ICIC0001071", 14, bankY + 20);
        doc.text("PAN NO: AAPFK1253N", 14, bankY + 24);
        doc.text("GSTIN: 27AAPFK1253N1ZV", 14, bankY + 28);
        doc.text("HSN CODE: 7018", 14, bankY + 32);

        // TOTALS
        let totalY = finalY + 5;
        const totalX = 140;
        const valX = 195;

        doc.setFont("helvetica", "bold");
        doc.text("Total", totalX, totalY);
        doc.text(data.subTotal, valX, totalY, {align:'right'});
        
        totalY += 6;
        doc.setFont("helvetica", "normal");
        
        if(data.isIGST) {
            doc.text(`IGST @${data.taxRate}%`, totalX, totalY);
            doc.text(data.taxAmount, valX, totalY, {align:'right'});
        } else {
            const halfRate = (data.taxRate / 2);
            const halfTax = (data.taxAmount / 2).toFixed(2);
            
            doc.text(`CGST ${halfRate}%`, totalX, totalY);
            doc.text(halfTax, valX, totalY, {align:'right'});
            totalY += 5;
            doc.text(`SGST ${halfRate}%`, totalX, totalY);
            doc.text(halfTax, valX, totalY, {align:'right'});
        }

        totalY += 8;
        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.text("G. Total", totalX, totalY);
        doc.text(data.grandTotal, valX, totalY, {align:'right'});

        // SIG
        const sigY = bankY + 45;
        doc.setFontSize(8);
        doc.setFont("helvetica", "normal");
        
        doc.text("Declaration", 14, sigY);
        doc.text("We declare that this invoice shows the actual price of the", 14, sigY + 4);
        doc.text("goods described and that all particulars are true and correct.", 14, sigY + 8);
        
        doc.setFont("helvetica", "bold");
        doc.text("KRYSTAL", 160, sigY, {align:'center'});
        doc.setFont("helvetica", "normal");
        doc.text("Authorised Signatory", 160, sigY + 15, {align:'center'});

        doc.text("SUBJECT TO MUMBAI JURISDICTION", 105, sigY + 25, {align:'center'});

        doc.save(`${data.invNo} ${data.client}.pdf`);
    }

    function formatDate(dateStr) {
        if(!dateStr) return "";
        const [y, m, d] = dateStr.split('-');
        return `${d}.${m}.${y}`;
    }

    // --- 5. HISTORY ---
    let allInvoices = [];
    const q = query(invCol, orderBy("timestamp", "desc"));
    onSnapshot(q, (snapshot) => {
        allInvoices = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
        renderHistory(allInvoices);
    });

    function renderHistory(data) {
        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = '';
        data.forEach(inv => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${inv.date}</td>
                <td>${inv.invNo}</td>
                <td><strong>${inv.client}</strong></td>
                <td>â‚¹${inv.grandTotal}</td>
                <td><button class="btn-download">Download PDF</button></td>
            `;
            row.querySelector('.btn-download').addEventListener('click', () => window.generatePDF(inv));
            tbody.appendChild(row);
        });
    }

    document.getElementById('searchHistory').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = allInvoices.filter(i => i.client.toLowerCase().includes(term));
        renderHistory(filtered);
    });

</script>

</body>
</html>